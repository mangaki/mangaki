---
- name: Install nginx
  become: true
  become_user: root
  apt: name=nginx update_cache=true state=latest
  tags: packages


- name: Create the (initial) nginx configuration for Let's Encrypt
  become: true
  become_user: root
  template:
    src: "letsencrypt.j2"
    dest: /etc/nginx/sites-available/{{ application_name }}
    backup: yes
  notify: reload nginx

- name: Ensure the default nginx site is disabled
  become: true
  become_user: root
  file: path=/etc/nginx/sites-enabled/default state=absent
  notify: reload nginx

- name: Ensure the application site is enabled
  become: true
  become_user: root
  file:
    src: /etc/nginx/sites-available/{{ application_name }}
    dest: /etc/nginx/sites-enabled/{{ application_name }}
    state: link
  notify: reload nginx

- name: Ensure nginx is running
  service: name=nginx state=started enabled=true
